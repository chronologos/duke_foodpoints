function getBudgets(e,t){t.get("/api/budgets/").success(function(t,a,n,o){t.forEach(function(e){e.percent=Math.min(e.spent/e.amount*100,100),e.elapsed=moment().diff(e.cutoff)/moment.duration(1,e.period).asMilliseconds()*100;var t=["progress-bar-success","progress-bar","progress-bar-striped","active"];t[0]=e.percent>e.elapsed?"progress-bar-warning":t[0],e["class"]=t.join(" "),e.display=e.spent.toFixed()+" of "+e.amount+" this "+e.period}),e.budgets=t})}function getTrans(e,t){for(var a=[],n=0;n<e.length;n++)if(e[n+1]){var o=e[n].balance-e[n+1].balance;a.push({amount:o.toFixed(2),date:e[n].date})}return a}function getFreqs(e){var t=[[0,0]];return e.forEach(function(e){for(var a=!1,n=0;n<t.length;n++)t[n][0]===e.amount&&(t[n][1]++,a=!0);a||t.push([e.amount,1])}),t}function getFav(e,t){var a=getFreqs(t);return a.sort(function(e,t){return t[1]-e[1]}),_.filter(a.slice(0,e),function(e){return e[1]>1})}function format(e){var t=moment(new Date(e)).format("MMMM Do YYYY, h:mm:ss a");return t}function getDeposits(e){var t=[];return e.forEach(function(e){e.amount<0&&e.amount<MAX_AMOUNT_BALANCEADDITION&&t.push(e.amount)}),_.sum(t)}angular.module("foodpoints",[]).controller("AverageSpendingController",["$scope","$http",function(e,t){var a,n;t.get("/api/spending").then(function(t){e.average=parseFloat(t.data).toFixed(2),a=e.average}),t.get("/api/personal").then(function(t){var a=t.data,n=parseFloat(a.day),o=parseFloat(a.week);e.dailyTotal=isNaN(n)?"Coming Soon!":n.toFixed(2),e.weeklyTotal=isNaN(o)?"Coming Soon!":o.toFixed(2)}),t.get("/api/spending/weekly").then(function(t){var o=t.data;console.log("Response received for weekly total is "+o);var r=parseFloat(o);n=7*a;var r=isNaN(r)?n:r.toFixed(2);e.wkAvg=r})}]).controller("BudgetController",["$scope","$http",function(e,t){t.get("/api/cutoffs/").success(function(t,a,n,o){e.periods=Object.keys(t),e.budget={amount:150,period:"week"}}),getBudgets(e,t),e.save=function(a){console.log(a),t.post("/api/budgets/",a).success(function(a,n,o,r){console.log(a),getBudgets(e,t)})},e["delete"]=function(a){t["delete"]("/api/budgets/"+a._id).success(function(a,n,o,r){getBudgets(e,t)})}}]).factory("infoFactory",function(){var e={},t=new Date,a=t.getMonth()>6?t.getFullYear():t.getFullYear()-1,n=112,o=116,r=getFirstWeekday(1,19,7,a),s=addDays(r,n),i=getFirstWeekday(3,2,0,a+1),l=addDays(i,o),c=t>r&&s>t,u=t>i&&l>t,m=u?i:r,f=u?l:s;return e.getInfo=function(){return{UPDATE_INTERVAL:200,DEFAULT_FOOD_POINTS:2152,MAX_AMOUNT_BALANCEADDITION:1500,fall:c,spring:u,start:m,end:f,fallstart:r,fallend:s,springstart:i,springend:l}},e}).service("UserService",["$rootScope","$http","$q","infoFactory",function(e,t,a,n){var o=n.getInfo();this.User=t.get("/api/user").then(function(e){return console.log("Data fetched using UserService Factory"),e.data}).then(function(e){return e.refresh_token_expire=format(e.refresh_token_expire),e.balance=e.balances[0].balance.toFixed(2),e.balances=e.balances.filter(function(e){return new Date(e.date)>o.start&&new Date(e.date)<o.end}),e.trans=getTrans(e.balances),e.favList=getFav(5,e.trans),e}),this.UserChange=function(e){this.User=e}}]),addDays=function(e,t){var a=new Date(e);return a.setDate(e.getDate()+t),a},getFirstWeekday=function(e,t,a,n){var o=new Date;for(o.setHours(0,0,0,0),o.setYear(n),o.setDate(t),o.setMonth(a);o.getDay()!==e;)o.setDate(o.getDate()+1);return o},angular.module("foodpoints").controller("HeatMapController",["$scope","$http","infoFactory","UserService",function(e,t,a,n){function o(){e.user.trans.forEach(function(e){if(e.amount<0){var t=moment(e.date).format("X"),a=moment().startOf("day").hours(moment(e.date).hours()).format("X"),n=-1*e.amount;l[t]=~~n,c[a]||(c[a]=0),c[a]+=~~n;for(var o=0;s>=o;o++)if(o>=s||n>o*r&&(o+1)*r>=n){i[o*r]?i[o*r]+=n:i[o*r]=n;break}}}),console.log(JSON.stringify(l));var t=new CalHeatMap;t.init({itemSelector:"#days",start:u.fallstart,range:3,previousSelector:"#animationDuration-previous",nextSelector:"#animationDuration-next",itemNamespace:"animationDuration-a",domain:"month",subDomain:"day",highlight:new Date,data:l,tooltip:!0,itemName:["",""],subDomainTextFormat:function(e,t){return t?t.toFixed():""},legendColors:{min:"#fcffa3",max:"#510d63",empty:"white"},legendVerticalPosition:"center",legendOrientation:"vertical",cellSize:16});var a=new CalHeatMap;a.init({itemSelector:"#hours",start:new Date,range:1,domain:"day",subDomain:"hour",domainLabelFormat:"",subDomainDateFormat:function(e){return moment(e).format("ha")},cellPadding:5,verticalOrientation:!0,colLimit:12,tooltip:!0,data:c,itemName:["",""],subDomainTextFormat:function(e,t){return t?t.toFixed():""},legendColors:{min:"#fcffa3",max:"#510d63",empty:"white"},cellSize:16})}var r=5,s=4,i={},l={},c={},u=a.getInfo();e.fetchUser=function(){n.User.then(function(t){e.user=t})},e.fetchUser(),e.user={},e.$watch("user",function(t,a){t!=a&&(e.$broadcast("userChange",{val:t}),console.log(t),o())})}]);var UPDATE_INTERVAL=500;angular.module("foodpoints").controller("MealPlanController",["$scope","$interval","infoFactory","UserService",function(e,t,a,n){function o(){t(function(){e.mealPlanCost=docCookies.getItem("mealPlanCost")||2152,e.selectedItemName=docCookies.getItem("mealPlan")||"Choose meal plan";var t=Math.min(e.user.balance/e.mealPlanCost,1);$("#progbar2").width(100*t+"%")},r.UPDATE_INTERVAL)}var r=a.getInfo();e.fetchUser=function(){n.User.then(function(t){e.user=t})},e.fetchUser(),e.user={},e.$watch("user",function(t,a){t!=a&&(e.$broadcast("userChange",{val:t}),console.log(t),o())}),e.dropboxitemselected=function(t){e.selectedItemName=t.name,e.mealPlanCost=t.value,docCookies.setItem("mealPlanCost",e.mealPlanCost),docCookies.setItem("mealPlan",e.selectedItemName),numfoodpoints=e.mealPlanCost},e.mealPlans=[{name:"Plan H ($432, Freshmen)",value:432},{name:"Plan I ($499, Freshmen)",value:499},{name:"Plan A ($2062)",value:2062},{name:"Plan B ($2473)",value:2473},{name:"Plan C ($2738)",value:2738},{name:"Plan D ($2938)",value:2938},{name:"Plan E ($3204)",value:3204},{name:"Plan F ($676, off-campus)",value:676},{name:"Plan J ($1458, central, off-campus)",value:1458}]}]);var MAX_AMOUNT_BALANCEADDITION=1500;angular.module("foodpoints").controller("ProjectionsController",["$scope","$http","infoFactory","UserService",function(e,t,a,n){function o(){var t=getDeposits(e.user.trans),a=e.user.balances[0],n=e.user.balances[e.user.balances.length-1],o=n.balance-a.balance-t,s=moment(a.date).diff(n.date),i=o/s,l=moment(a.date).diff(r.start)*i+a.balance,c=moment(a.date).diff(r.end)*i+a.balance+t,u=moment.duration(1,"day").asMilliseconds()*i,m=moment.duration(1,"week").asMilliseconds()*i,f=moment.duration(1,"month").asMilliseconds()*i;e.projections=[{time:"Starting Balance",amount:l},{time:"Added Balance",amount:t},{time:"Ending Balance",amount:c},{time:"Per day",amount:u},{time:"Per week",amount:m},{time:"Per month",amount:f}]}var r=a.getInfo();e.fetchUser=function(){n.User.then(function(t){e.user=t})},e.fetchUser(),e.user={},e.$watch("user",function(t,a){t!=a&&(e.$broadcast("userChange",{val:t}),console.log(t),o())})}]),angular.module("foodpoints").controller("UserController",["$scope","$rootScope","$http","$interval","UserService","infoFactory",function(e,t,a,n,o,r){function s(){if(i.fall||i.spring){n(function(){e.mealPlanCost=docCookies.getItem("mealPlanCost")||2152;var t=new Date,a=1-(t-i.start)/(i.end-i.start);e.shouldHave=(e.mealPlanCost*a).toFixed(4),$("#progbar").width(100*a+"%")},i.UPDATE_INTERVAL)}else e.result=0}var i=r.getInfo();e.fetchUser=function(){o.User.then(function(t){e.user=t})},e.fetchUser(),e.user={},e.$watch("user",function(t,a){t!=a&&(e.$broadcast("userChange",{val:t}),console.log(t),s())})}]);