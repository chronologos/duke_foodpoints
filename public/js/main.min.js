function addDays(e,t){var a=new Date(e);return a.setDate(e.getDate()+t),a}function getFirstWeekday(e,t,a,n){var o=new Date;for(o.setHours(0,0,0,0),o.setYear(n),o.setDate(t),o.setMonth(a);o.getDay()!==e;)o.setDate(o.getDate()+1);return o}function format(e){var t=moment(new Date(e)).format("MMMM Do YYYY, h:mm:ss a");return t}var docCookies={getItem:function(e){return e?decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null:null},setItem:function(e,t,a,n,o,r){if(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))return!1;var i="";if(a)switch(a.constructor){case Number:i=a===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+a;break;case String:i="; expires="+a;break;case Date:i="; expires="+a.toUTCString()}return document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+i+(o?"; domain="+o:"")+(n?"; path="+n:"")+(r?"; secure":""),!0},removeItem:function(e,t,a){return this.hasItem(e)?(document.cookie=encodeURIComponent(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(a?"; domain="+a:"")+(t?"; path="+t:""),!0):!1},hasItem:function(e){return e?new RegExp("(?:^|;\\s*)"+encodeURIComponent(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie):!1},keys:function(){for(var e=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),t=e.length,a=0;t>a;a++)e[a]=decodeURIComponent(e[a]);return e}},numfoodpoints,user,start,end,currdate=new Date,acadyear=currdate.getMonth()>6?currdate.getFullYear():currdate.getFullYear()-1,DEFAULT_FOOD_POINTS=2152,UPDATE_INTERVAL=200,FALL_LENGTH=112,SPRING_LENGTH=116,MAX_AMOUNT_BALANCEADDITION=1500,fallstart=getFirstWeekday(1,19,7,acadyear),fallend=addDays(fallstart,FALL_LENGTH),springstart=getFirstWeekday(3,2,0,acadyear+1),springend=addDays(springstart,SPRING_LENGTH);$(document).ready(function(){$(".format").each(function(){$(this).text(format($(this).text()))}),$.ajax({url:"/api/user"}).always(function(e,t,a){"success"===t&&(user=e);var n=currdate>fallstart&&fallend>currdate,o=currdate>springstart&&springend>currdate;start=o?springstart:fallstart,end=o?springend:fallend;var r=0,i=0;if(user&&(user.balances=user.balances.filter(function(e){return new Date(e.date)>start&&new Date(e.date)<end}),user.balances.length>0)){var s=user.balances[0],m=user.balances[user.balances.length-1],c=0,u=[];user.trans.forEach(function(e){e.amount>0&&e.amount<MAX_AMOUNT_BALANCEADDITION&&u.push(e.amount)}),u.forEach(function(e){c+=e});var d=m.balance-s.balance-c,l=moment(s.date).diff(m.date),f=d/l;r=moment(s.date).diff(start)*f+s.balance,i=moment(s.date).diff(end)*f+s.balance+c;for(var p=moment.duration(1,"day").asMilliseconds()*f,g=moment.duration(1,"week").asMilliseconds()*f,h=moment.duration(1,"month").asMilliseconds()*f,D=[{time:"Starting Balance",amount:r},{time:"Added Balance",amount:c},{time:"Ending Balance",amount:i},{time:"Per day",amount:p},{time:"Per week",amount:g},{time:"Per month",amount:h}],w=0;w<D.length;w++)$("#projections").append("<tr><td>"+D[w].time+"</td><td>"+D[w].amount.toFixed(2)+"</td></tr>")}var v=docCookies.getItem("numfoodpoints");if(numfoodpoints=parseInt(v||r||DEFAULT_FOOD_POINTS),$("#plan").val(numfoodpoints).change(),n||o?setInterval(function(){var e=new Date,t=1-(e-start)/(end-start),a=(numfoodpoints*t).toFixed(4);$("#result").html(a),$("#progbar").width(100*t+"%")},UPDATE_INTERVAL):$("#result").html("0.00"),user){var y=["Food Points"],u=[],I=["x2"],b=5,x=4,T={},N={},A={};user.balances.forEach(function(e){I.push(new Date(e.date)),y.push(e.balance)}),user.trans.forEach(function(e){if(e.amount<0){var t=moment(e.date).format("X"),a=moment().startOf("day").hours(moment(e.date).hours()).format("X"),n=-1*e.amount;N[t]=~~n,A[a]||(A[a]=0),A[a]+=~~n;for(var o=0;x>=o;o++)if(o>=x||n>o*b&&(o+1)*b>=n){T[o*b]?T[o*b]+=n:T[o*b]=n;break}}});var E=new CalHeatMap;E.init({itemSelector:"#days",start:fallstart,range:3,previousSelector:"#animationDuration-previous",nextSelector:"#animationDuration-next",itemNamespace:"animationDuration-a",domain:"month",subDomain:"day",highlight:new Date,data:N,tooltip:!0,itemName:["",""],subDomainTextFormat:function(e,t){return t?t.toFixed():""},legendColors:{min:"#fcffa3",max:"#510d63",empty:"white"},legendVerticalPosition:"center",legendOrientation:"vertical",cellSize:16});var F=new CalHeatMap;F.init({itemSelector:"#hours",start:new Date,range:1,domain:"day",subDomain:"hour",domainLabelFormat:"",subDomainDateFormat:function(e){return moment(e).format("ha")},cellPadding:5,verticalOrientation:!0,colLimit:12,tooltip:!0,data:A,itemName:["",""],subDomainTextFormat:function(e,t){return t?t.toFixed():""},legendColors:{min:"#fcffa3",max:"#510d63",empty:"white"},cellSize:16})}})}),function(e,t,a,n,o,r,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,r=t.createElement(a),i=t.getElementsByTagName(a)[0],r.async=1,r.src=n,i.parentNode.insertBefore(r,i)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-45337794-1","foodpoints.herokuapp.com"),ga("send","pageview");